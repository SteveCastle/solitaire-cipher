<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Solitaire Cipher</title>
    <link rel="stylesheet" href="https://netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css" />
	<link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.10.4/themes/smoothness/jquery-ui.css" />
    <link rel="stylesheet" href="css/cards.css" />
	<style>
.card{
	width:62px;
	height:90px;
	position:relative;
	margin:5px;
	float:left;
    background-size:100%;
    color:red;
}
	</style>
</head>
<body>

	<div class="container">
        <h1>Solitaire Cipher Demo</h1>
        <div class="row">
  <div class="col-lg-12 well">
    <input type="text" class="form-control" placeholder="Plain Text">
  </div>
  <hr>
</div>
<div class="row well">
    <div class="btn-group col-lg-12">
             <button type="button" class="btn btn-warning" onclick="CardDeck.shuffle()">Shuffle</button>
            <button type="button" class="btn btn-success" onclick="CardDeck.stream(15)">Generate Key Stream</button>
            <button type="button" class="btn btn-success" onclick="CardDeck.cycle_a()">Play</button>
        </div>
</div>

        <div class="row">
            <div class="col-lg-12 well">
                <h3>KeyStream</h3>
                <div class="well keystream"></div>
                <div class="alert alert-info step-info"></div>
                <div class="cards"></div>
            </div>
        </div>
        <div class="row">
  <div class="col-lg-12 well">
    <input type="text" class="form-control" placeholder="Cipher Text">
  </div>
  <hr>
</div>
        
    </div>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.10.4/jquery-ui.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.6.0/underscore-min.js"></script>
	<script>
    var CardDeck ={
    	order: [],
    	init: function(){
    		for(var i=1;i<=54;i++){
    			this.order.push(i);
    		}
    		this.order = this.shuffle(this.order);
    		this.draw();
    	},
        shuffle: function shuffle(o){
        	if(!o){
        		o = this.order;
        	}
            for(var j, x, i = o.length; i; j = Math.floor(Math.random() * i), x = o[--i], o[i] = o[j], o[j] = x);
            	this.draw();
            return o;
},
        cycle_a: function(order){
            var a_joker,b_joker,difference,top_set,bottom_set,middle_set;
            a_joker = this.order.indexOf(53);
            b_joker = this.order.indexOf(54);
            //Step One: Swap A Joker with the Card Below It
            if(a_joker<53){
                swap = this.order[a_joker+1];
                this.order[a_joker+1] = 53;
                this.order[a_joker] = swap;
            }
            else{
                difference = a_joker - 53;
                swap = this.order[difference];
                this.order[difference] = 53;
                this.order[a_joker] = swap;
            }
            console.log(this.order);
            $('.step-info').html("<p>First: Find Joker A, in this case our red joker and move it one card down the deck, from the top. If it is the last card, move it to the top spot on the deck.</p>");
            this.draw();
        },
        cycle_b: function(order){
            //Step Two: Swap B Joker with the Card Two Below It
            a_joker = this.order.indexOf(53);
            b_joker = this.order.indexOf(54);
            if(b_joker<52){
                swap = this.order[b_joker+2];
                this.order[b_joker+2] = 54;
                this.order[b_joker] = swap;
            }
            else{
                difference = (b_joker-53);
                swap = this.order[difference+1];
                this.order[difference+1] = 54;
                this.order[b_joker] = swap;
            }
            console.log(this.order);
            this.draw();
        },
        tripple_cut: function(order){
            //Step Three: Triple Cut Cards Above Top Joker and Below Bottom Joker
            a_joker = this.order.indexOf(53);
            b_joker = this.order.indexOf(54);
            if(a_joker>b_joker){
                top_set = this.order.slice(0,b_joker);
                bottom_set = this.order.slice(a_joker+1);
                middle_set = this.order.slice(b_joker,a_joker+1);
            }
            else{
            top_set = this.order.slice(0,a_joker);
            bottom_set = this.order.slice(b_joker+1);
            middle_set = this.order.slice(a_joker,b_joker+1);
            }
            this.order.length = 0;
            this.order = bottom_set.concat(middle_set,top_set);
            console.log(this.order);
            this.draw();
        },
        find_key: function(order){
        var top_card = this.order[0];
        return this.order[top_card+2];
        },
        count_cut: function(){
            //Step Four- Find number of the bottom card, count down this many cards from the top and cut to the bottom, but above the last card. 
            bottom_card = this.order[53];
            if(bottom_card<53){
            top_set = this.order.slice(0,bottom_card);
            middle_set = this.order.slice(bottom_card,53);
            console.log(bottom_card,top_set,middle_set);
            this.order.length = 0;
            this.order = middle_set.concat(top_set,bottom_card);
            }
            console.log(this.order,this.order.length);
            this.draw();
  
        },

        get_character: function(order){
            this.cycle_a();

            this.cycle_b();
            this.tripple_cut();   
            this.count_cut(); 
            keystreamChar = this.find_key();
            if (keystreamChar<53){
            return keystreamChar;
            }else{
                return false;
            }

        },
        draw: function(){
        	$('.cards').empty();
            _.each(this.order,function(card){
            $('.cards').append("<div class='card "+ CardDeck.get_suit_and_rank(card).rank+CardDeck.get_suit_and_rank(card).suit+ "'data-card=''></div>")
            });
        },
        get_suit_and_rank: function(card){
        	var suit,rank,rank_position;
        	var ranks = ["ace","two","three","four","five","six","seven","eight","nine","ten","jack","queen","king"];
        	if(card>52){return {rank:"joker", suit:card}}
        		else{
        			rank_position = (card-1)%13;
        			rank = ranks[rank_position]
        		}
            if(card<=13){
            	suit = "clubs"
            }
            else if(card>=14 && card<=26){
            	suit = "diamonds"
            }
            else if(card>=27 && card<=39){
                suit = "hearts"
            }
            else{
                suit = "spades"
            }
        	return{suit:suit,rank:rank}
        },
        stream: function(msg_length){
            var key_stream = [],character;
            var i = 0;
            while(i<msg_length){
            character = this.get_character();
            if(character){
            key_stream.push(character);
            $('.keystream').html("<p>"+key_stream+"</p>");
            i++;
            }                
            }
            console.log(key_stream);
            return key_stream;
        }

    }

    $(document).ready(function(){
        CardDeck.init();
    });
	</script>
</body>
</html>